#' Read in GDX and calculate electricity generation, used in convGDX2MIF.R for the reporting
#' 
#' Read in electricity generation data from GDX file, information used in convGDX2MIF.R
#' for the reporting
#' 
#' 
#' @param gdx a GDX object as created by readGDX, or the path to a gdx
#' @param output a magpie object containing all needed variables generated by other report*.R functions
#' @return MAgPIE object - contains the Generation variables
#' @author Sebastian Osorio, Renato Rodrigues
#' @seealso \code{\link{convGDX2MIF}}
#' @examples
#' 
#' \dontrun{reportGeneration(gdx)}
#'
#' @importFrom gdx readGDX
#' @importFrom magclass mbind setNames dimSums getSets getSets<- as.magpie
#' @export
#' 
reportGeneration <- function(gdx,output=NULL) {
  
  if(is.null(output)){
    stop("please provide a file containing all needed information")
  }
  
  # read sets
  time <- readGDX(gdx,name="t")
  tehe <- readGDX(gdx,name="tehe")
  teel <- readGDX(gdx,name="teel") #set of electricity generation technologies (non-storage)
  ter <- readGDX(gdx,name="ter") #set of variable renewable electricity generation technologies
  ternofluc <- readGDX(gdx,name="ternofluc") #set of non-variable (non-fluctuating) renewable electricity generation technologies
  tefossil <- readGDX(gdx,name="tefossil") #set of fossil-based electricity generation technologies
  tenr <- readGDX(gdx,name="tenr") #set of non-renewable electricity generation technologies (includes storage)
  tegas <- readGDX(gdx,name="tegas") #set of gas generation technologies
  telig <- readGDX(gdx,name="telig") #set of lignite generation technologies
  tecoal <- readGDX(gdx,name="tecoal") #set of hard coal generation technologies
  tengcc <- readGDX(gdx,name="tengcc") #set of NGCC generation technologies
  tehydro <- readGDX(gdx,name="tehydro") #set of hydropower generation technologies
  tehgen <- readGDX(gdx,name="tehgen")
  tehydro <- readGDX(gdx,name="tehydro")
  tebio <- readGDX(gdx,name="tebio")
  teoil <- readGDX(gdx,name="teoil")
  techp <- readGDX(gdx,name="techp")
  teccs <- readGDX(gdx,name="teccs")
  teothers <- readGDX(gdx,name="teothers")
  tau <- readGDX(gdx,name="tau") #set of time slices
  pety <- readGDX(gdx,name="pety") #set of primary energies
  tegas_el <- intersect(tegas,teel)
  tengcc_el <- intersect(tengcc,teel)
  pe2se <- readGDX(gdx,name="pe2se")
  pe2se <- paste0(pe2se[,1],".",pe2se[,2],".",pe2se[,3])
  
  # read parameters and sets
  p_taulength <- readGDX(gdx,name="p_taulength",field="l",format="first_found")[,,tau] #number of hours/year per tau
  p_tedata <- readGDX(gdx,name="p_tedata",field="l",format="first_found") #parameter per technology
  c_LIMESversion <- readGDX(gdx,name="c_LIMESversion",field="l",format="first_found")
  
  # read variables
  v_seprod <- readGDX(gdx,name="v_seprod",field="l",format="first_found",restore_zeros = FALSE)[,,tau]
  v_storeout <- readGDX(gdx,name="v_storeout",field="l",format="first_found")[,,tau]
  v_storein <- readGDX(gdx,name="v_storein",field="l",format="first_found")[,,tau]
  v_exdemand <- readGDX(gdx,name="v_exdemand",field="l",format="first_found",restore_zeros = FALSE)[,,tau] #demand
  
  #Make sure only the sets -> to reduce the size of the variables
  #v_seprod <- v_seprod[,,pe2se]
  v_seprod <- v_seprod[,,pety]
  p_autocons <- p_tedata[,,"autocons"]

  # create MagPie object of variables with iso3 regions
  v_seprod <- limesMapping(v_seprod)
  v_storeout <- limesMapping(v_storeout)
  v_storein <- limesMapping(v_storein)
  v_exdemand <- limesMapping(v_exdemand)
  p_autocons <- limesMapping(p_autocons)
  
  #Check the version so to choose the electricity-related variables
  if(c_LIMESversion >= 2.28) {
    
    v_seprod_el <- v_seprod[,,"seel"]
    c_heating <- readGDX(gdx,name="c_heating",field="l",format="first_found")
    if(c_heating == 1) {
      v_seprod_he <- v_seprod[,,"sehe"]
      v_seprod_he <- collapseNames(v_seprod_he)
      p_eldemand <- v_exdemand[,,"seel"]
      #v_seprod_el <- v_seprod[,,"seel"]
    } else {
      p_eldemand <- v_exdemand
      #v_seprod_el <- v_seprod
    }
    
  } else {
    p_eldemand <- v_exdemand
    v_seprod_el <- v_seprod
  }
  #Collapse names to avoid some problems
  p_eldemand <- collapseNames(p_eldemand)
  v_seprod_el <- collapseNames(v_seprod_el)
  
  
  #generation per aggregated technology per country
  #and converting from GWh to TWh
  tmp1 <- NULL
  
  varList_el <- list(
    #Conventional
    "Secondary Energy|Electricity (TWh/yr)"                  =c(teel),
    "Secondary Energy|Electricity|Biomass (TWh/yr)"          =intersect(teel,tebio),
    "Secondary Energy|Electricity|Biomass|w/o CCS (TWh/yr)"  =intersect(teel,setdiff(tebio,teccs)),
    "Secondary Energy|Electricity|Coal (TWh/yr)"             =intersect(teel,c(tecoal,telig)),
    "Secondary Energy|Electricity|Coal|w/o CCS (TWh/yr)"     =intersect(teel,setdiff(c(tecoal,telig),teccs)),
    "Secondary Energy|Electricity|Coal|w/ CCS (TWh/yr)"      =intersect(teel,intersect(c(tecoal,telig),teccs)),
    "Secondary Energy|Electricity|Hard Coal (TWh/yr)"        =intersect(teel,c(tecoal)),
    "Secondary Energy|Electricity|Hard Coal|w/o CCS (TWh/yr)"=intersect(teel,setdiff(c(tecoal),teccs)),
    "Secondary Energy|Electricity|Hard Coal|w/ CCS (TWh/yr)" =intersect(teel,intersect(c(tecoal),teccs)),
    "Secondary Energy|Electricity|Lignite (TWh/yr)"          =intersect(teel,c(telig)),
    "Secondary Energy|Electricity|Lignite|w/o CCS (TWh/yr)"  =intersect(teel,setdiff(c(telig),teccs)),
    "Secondary Energy|Electricity|Lignite|w/ CCS (TWh/yr)"   =intersect(teel,intersect(c(telig),teccs)),
    "Secondary Energy|Electricity|Oil (TWh/yr)"              =intersect(teel,c(teoil)),
    "Secondary Energy|Electricity|Gas (TWh/yr)"              =intersect(teel,c(tegas)),
    "Secondary Energy|Electricity|Gas|w/o CCS (TWh/yr)"      =intersect(teel,setdiff(tegas_el,teccs)),
    "Secondary Energy|Electricity|Gas|w/ CCS (TWh/yr)"       =intersect(teel,intersect(tegas_el,teccs)),
    "Secondary Energy|Electricity|Gas CC|w/o CCS (TWh/yr)"   =intersect(teel,setdiff(tengcc_el,teccs)),
    "Secondary Energy|Electricity|Gas CC|w/ CCS (TWh/yr)"    =intersect(teel,intersect(tengcc_el,teccs)),
    "Secondary Energy|Electricity|Gas CC (TWh/yr)"           =intersect(teel,c(tengcc_el)),
    "Secondary Energy|Electricity|Gas OC (TWh/yr)"           =intersect(teel,setdiff(tegas_el,tengcc_el)),
    "Secondary Energy|Electricity|Other (TWh/yr)"            =intersect(teel,c(teothers)),
    "Secondary Energy|Electricity|Hydrogen (TWh/yr)"         =intersect(teel,c(tehgen)),
    "Secondary Energy|Electricity|Hydrogen FC (TWh/yr)"      =intersect(teel,c("hfc")),
    "Secondary Energy|Electricity|Hydrogen OC (TWh/yr)"      =intersect(teel,c("hct")),
    "Secondary Energy|Electricity|Hydrogen CC (TWh/yr)"      =intersect(teel,c("hcc")),
    "Secondary Energy|Electricity|Nuclear (TWh/yr)"          =intersect(teel,c("tnr")),
    "Secondary Energy|Electricity|Waste (TWh/yr)"            =intersect(teel,c("waste")),
    "Secondary Energy|Electricity|Other Fossil (TWh/yr)"     =intersect(teel,c(teothers,"waste",teoil)),
    
    #general aggregation
    "Secondary Energy|Electricity|Fossil (TWh/yr)"                 =intersect(teel,c(tefossil)),
    "Secondary Energy|Electricity|Fossil|w/o CCS (TWh/yr)"         =intersect(teel,setdiff(tefossil,teccs)),
    "Secondary Energy|Electricity|Fossil|w/ CCS (TWh/yr)"          =intersect(teel,intersect(tefossil,teccs)),
    "Secondary Energy|Electricity|Variable renewable (TWh/yr)"     =intersect(teel,c(ter)),
    "Secondary Energy|Electricity|Non-variable renewable (TWh/yr)" =intersect(teel,c(ternofluc)),
    "Secondary Energy|Electricity|Renewable (TWh/yr)"              =intersect(teel,c(ter,ternofluc)),
    "Secondary Energy|Electricity|Non-renewable (TWh/yr)"          =intersect(teel,tenr), #this does not include storage
    
    #Renewable
    "Secondary Energy|Electricity|Wind (TWh/yr)"         =intersect(teel,c("windon","windoff")),       
    "Secondary Energy|Electricity|Wind|Onshore (TWh/yr)" =intersect(teel,c("windon")),   
    "Secondary Energy|Electricity|Wind|Offshore (TWh/yr)"=intersect(teel,c("windoff")),      
    "Secondary Energy|Electricity|Solar (TWh/yr)"        =intersect(teel,c("spv","csp")),
    "Secondary Energy|Electricity|Solar|PV (TWh/yr)"     =intersect(teel,c("spv")), 
    "Secondary Energy|Electricity|Solar|CSP (TWh/yr)"    =intersect(teel,c("csp")),  
    "Secondary Energy|Electricity|Hydro (TWh/yr)"        =intersect(teel,c(tehydro))
  )
  
  for (var in names(varList_el)){
    tmp1 <- mbind(tmp1,setNames(dimSums(dimSums(v_seprod_el[,,varList_el[[var]]],dim=c(3.2,3.3))*p_taulength,dim=3)/1000,var))
  }
  
  #general aggregation
  tmp1 <- mbind(tmp1,setNames(dimSums((dimSums(v_seprod_el[,,c(teel)],dim=c(3.2,3.3)) + dimSums(v_storeout,dim=c(3.2)))*p_taulength,dim=3)/1000,"Secondary Energy|Electricity|w/ storage (TWh/yr)"))
  tmp1 <- mbind(tmp1,setNames(dimSums((dimSums(v_seprod_el[,,c(teel)],dim=c(3.2,3.3)) + dimSums(v_storeout,dim=c(3.2)) - dimSums(v_storein,dim=c(3.2)))*p_taulength,dim=3)/1000,"Secondary Energy||Electricity|w/o losses (TWh/yr)"))
  
  tmp2 <- NULL
  #when there is endogenous heating
  if(c_LIMESversion >= 2.33) {
    tewaste <- readGDX(gdx,name="tewaste") #set of waste generation technologies
    tedh <- readGDX(gdx,name="tedh") #set of District Heating generation technologies
    tedhelec <- readGDX(gdx,name="tedhelec") #set of electric District Heating generation technologies
    teoel <- readGDX(gdx,name="teoel") #set of electric District Heating generation technologies
    
    #Electricity (new technologies)
    tmp2 <- mbind(tmp2,setNames(dimSums(dimSums(v_seprod_el[,,intersect(tebio,teccs)],dim=c(3.2,3.3))*p_taulength,dim=3)/1000,"Secondary Energy|Electricity|Biomass|w/ CCS (TWh/yr)"))
    
    if(c_heating == 1) {
      #1) HEAT FROM CHP AND DH
      varList_he <- list(
        #1.a) Both
        "Secondary Energy|Heat (TWh/yr)"               =NA,
        "Secondary Energy|Heat|Biomass (TWh/yr)"       =intersect(tehe,tebio),
        "Secondary Energy|Heat|Coal (TWh/yr)"          =intersect(tehe,c(tecoal,telig)),
        "Secondary Energy|Heat|Hard Coal (TWh/yr)"     =intersect(tehe,c(tecoal)),
        "Secondary Energy|Heat|Lignite (TWh/yr)"       =intersect(tehe,c(telig)),
        "Secondary Energy|Heat|Oil (TWh/yr)"           =intersect(tehe,c(teoil)),
        "Secondary Energy|Heat|Gas (TWh/yr)"           =intersect(tehe,c(tegas)),
        "Secondary Energy|Heat|Gas CC (TWh/yr)"        =intersect(tehe,c(tengcc_el)),
        "Secondary Energy|Heat|Gas OC (TWh/yr)"        =intersect(tehe,setdiff(tegas_el,tengcc_el)),
        "Secondary Energy|Heat|Other (TWh/yr)"         =intersect(tehe,c(teothers)),
        "Secondary Energy|Heat|Waste (TWh/yr)"         =intersect(tehe,c(tewaste)),
        "Secondary Energy|Heat|Other Fossil (TWh/yr)"  =intersect(tehe,c(teothers,tewaste,teoil)),
        "Secondary Energy|Heat|Electricity (TWh/yr)"   =intersect(tehe,c(tedhelec)),
        "Secondary Energy|Heat|Solar (TWh/yr)"         =intersect(tehe,c("sol_heat")),
        "Secondary Energy|Heat|Geothermal (TWh/yr)"    =intersect(tehe,c("geo_heat")),
        "Secondary Energy|Heat|Fossil (TWh/yr)"        =intersect(tehe,c(tefossil)),
        "Secondary Energy|Heat|Renewable (TWh/yr)"     =intersect(tehe,c(ter,ternofluc)),
        "Secondary Energy|Heat|Non-renewable (TWh/yr)" =intersect(tehe,tenr),
        
        #1.b) CHP
        "Secondary Energy|Heat|CHP (TWh/yr)"               =c(techp),
        "Secondary Energy|Heat|CHP|Biomass (TWh/yr)"       =intersect(techp,tebio),
        "Secondary Energy|Heat|CHP|Coal (TWh/yr)"          =intersect(techp,c(tecoal,telig)),
        "Secondary Energy|Heat|CHP|Hard Coal (TWh/yr)"     =intersect(techp,c(tecoal)),
        "Secondary Energy|Heat|CHP|Lignite (TWh/yr)"       =intersect(techp,c(telig)),
        "Secondary Energy|Heat|CHP|Oil (TWh/yr)"           =intersect(techp,c(teoil)),
        "Secondary Energy|Heat|CHP|Gas (TWh/yr)"           =intersect(techp,c(tegas)),
        "Secondary Energy|Heat|CHP|Gas CC (TWh/yr)"        =intersect(techp,c(tengcc_el)),
        "Secondary Energy|Heat|CHP|Gas OC (TWh/yr)"        =intersect(techp,setdiff(tegas_el,tengcc_el)),
        "Secondary Energy|Heat|CHP|Other (TWh/yr)"         =intersect(techp,c(teothers)),
        "Secondary Energy|Heat|CHP|Other Fossil (TWh/yr)"  =intersect(techp,c(teothers,tewaste,teoil)),
        "Secondary Energy|Heat|CHP|Fossil (TWh/yr)"        =intersect(techp,c(tefossil)),
        "Secondary Energy|Heat|CHP|Renewable (TWh/yr)"     =intersect(techp,c(ter,ternofluc)),
        "Secondary Energy|Heat|CHP|Non-renewable (TWh/yr)" =intersect(techp,tenr),
        
        #1.c) District Heating
        "Secondary Energy|Heat|District Heating (TWh/yr)"                             =c(tedh),
        "Secondary Energy|Heat|District Heating|Biomass (TWh/yr)"                     =intersect(tedh,tebio),
        "Secondary Energy|Heat|District Heating|Coal (TWh/yr)"                        =intersect(tedh,c(tecoal,telig)),
        "Secondary Energy|Heat|District Heating|Hard Coal (TWh/yr)"                   =intersect(tedh,c(tecoal)),
        "Secondary Energy|Heat|District Heating|Lignite (TWh/yr)"                     =intersect(tedh,c(telig)),
        "Secondary Energy|Heat|District Heating|Oil (TWh/yr)"                         =intersect(tedh,c(teoil)),
        "Secondary Energy|Heat|District Heating|Gas (TWh/yr)"                         =intersect(tedh,c(tegas)),
        "Secondary Energy|Heat|District Heating|Other (TWh/yr)"                       =intersect(tedh,c(teothers)),
        "Secondary Energy|Heat|District Heating|Waste (TWh/yr)"                       =intersect(tedh,c(tewaste)),
        "Secondary Energy|Heat|District Heating|Other Fossil (TWh/yr)"                =intersect(tedh,c(teothers,tewaste,teoil)),
        "Secondary Energy|Heat|District Heating|Electricity (TWh/yr)"                 =intersect(tedh,c(tedhelec)),
        "Secondary Energy|Heat|District Heating|Electricity|Heat Pump (TWh/yr)"       =intersect(tedh,"hpump"),
        "Secondary Energy|Heat|District Heating|Electricity|Electric Boiler (TWh/yr)" =intersect(tedh,"elboil"),
        "Secondary Energy|Heat|District Heating|Solar (TWh/yr)"                       =intersect(tedh,c("sol_heat")),
        "Secondary Energy|Heat|District Heating|Geothermal (TWh/yr)"                  =intersect(tedh,c("geo_heat")),
        "Secondary Energy|Heat|District Heating|Fossil (TWh/yr)"                      =intersect(tedh,c(tefossil)),
        "Secondary Energy|Heat|District Heating|Renewable (TWh/yr)"                   =intersect(tedh,c(ter,ternofluc)),
        "Secondary Energy|Heat|District Heating|Non-renewable (TWh/yr)"               =intersect(tedh,tenr)
      )
      
      for (var in names(varList_he)){
        tmp2 <- mbind(tmp2,setNames(dimSums(dimSums(v_seprod_he[,,varList_he[[var]]],dim=c(3.2,3.3))*p_taulength,dim=3)/1000,var))
      }
      
      #2. ELECTRICITY FROM CHP AND ELECTRICITY-ONLY PLANTS
      varList_el2 <- list(
        #2.a) CHP
        "Secondary Energy|Electricity|CHP (TWh/yr)"               =c(techp),
        "Secondary Energy|Electricity|CHP|Biomass (TWh/yr)"       =intersect(techp,tebio),
        "Secondary Energy|Electricity|CHP|Coal (TWh/yr)"          =intersect(techp,c(tecoal,telig)),
        "Secondary Energy|Electricity|CHP|Hard Coal (TWh/yr)"     =intersect(techp,c(tecoal)),
        "Secondary Energy|Electricity|CHP|Lignite (TWh/yr)"       =intersect(techp,c(telig)),
        "Secondary Energy|Electricity|CHP|Oil (TWh/yr)"           =intersect(techp,c(teoil)),
        "Secondary Energy|Electricity|CHP|Gas (TWh/yr)"           =intersect(techp,c(tegas)),
        "Secondary Energy|Electricity|CHP|Gas CC (TWh/yr)"        =intersect(techp,c(tengcc_el)),
        "Secondary Energy|Electricity|CHP|Gas OC (TWh/yr)"        =intersect(techp,setdiff(tegas_el,tengcc_el)),
        "Secondary Energy|Electricity|CHP|Other (TWh/yr)"         =intersect(techp,c(teothers)),
        "Secondary Energy|Electricity|CHP|Other Fossil (TWh/yr)"  =intersect(techp,c(teothers,tewaste,teoil)),
        "Secondary Energy|Electricity|CHP|Fossil (TWh/yr)"        =intersect(techp,c(tefossil)),
        "Secondary Energy|Electricity|CHP|Renewable (TWh/yr)"     =intersect(techp,c(ter,ternofluc)),
        "Secondary Energy|Electricity|CHP|Non-renewable (TWh/yr)" =intersect(techp,tenr),
        
        #2.b) Electricity-only
        "Secondary Energy|Electricity|Electricity-only (TWh/yr)"                  =c(teoel),
        "Secondary Energy|Electricity|Electricity-only|Biomass (TWh/yr)"          =intersect(teoel,tebio),
        "Secondary Energy|Electricity|Electricity-only|Biomass|w/o CCS (TWh/yr)"  =intersect(teoel,setdiff(tebio,teccs)),
        "Secondary Energy|Electricity|Electricity-only|Coal (TWh/yr)"             =intersect(teoel,c(tecoal,telig)),
        "Secondary Energy|Electricity|Electricity-only|Coal|w/o CCS (TWh/yr)"     =intersect(teoel,setdiff(c(tecoal,telig),teccs)),
        "Secondary Energy|Electricity|Electricity-only|Coal|w/ CCS (TWh/yr)"      =intersect(teoel,intersect(c(tecoal,telig),teccs)),
        "Secondary Energy|Electricity|Electricity-only|Hard Coal (TWh/yr)"        =intersect(teoel,c(tecoal)),
        "Secondary Energy|Electricity|Electricity-only|Hard Coal|w/o CCS (TWh/yr)"=intersect(teoel,setdiff(c(tecoal),teccs)),
        "Secondary Energy|Electricity|Electricity-only|Hard Coal|w/ CCS (TWh/yr)" =intersect(teoel,intersect(c(tecoal),teccs)),
        "Secondary Energy|Electricity|Electricity-only|Lignite (TWh/yr)"          =intersect(teoel,c(telig)),
        "Secondary Energy|Electricity|Electricity-only|Lignite|w/o CCS (TWh/yr)"  =intersect(teoel,setdiff(c(telig),teccs)),
        "Secondary Energy|Electricity|Electricity-only|Lignite|w/ CCS (TWh/yr)"   =intersect(teoel,intersect(c(telig),teccs)),
        "Secondary Energy|Electricity|Electricity-only|Oil (TWh/yr)"              =intersect(teoel,c(teoil)),
        "Secondary Energy|Electricity|Electricity-only|Gas (TWh/yr)"              =intersect(teoel,c(tegas)),
        "Secondary Energy|Electricity|Electricity-only|Gas|w/o CCS (TWh/yr)"      =intersect(teoel,setdiff(tegas_el,teccs)),
        "Secondary Energy|Electricity|Electricity-only|Gas|w/ CCS (TWh/yr)"       =intersect(teoel,intersect(tegas_el,teccs)),
        "Secondary Energy|Electricity|Electricity-only|Gas CC (TWh/yr)"           =intersect(teoel,c(tengcc_el)),
        "Secondary Energy|Electricity|Electricity-only|Gas OC (TWh/yr)"           =intersect(teoel,setdiff(tegas_el,tengcc_el)),
        "Secondary Energy|Electricity|Electricity-only|Other (TWh/yr)"            =intersect(teoel,c(teothers)),
        "Secondary Energy|Electricity|Electricity-only|Hydrogen (TWh/yr)"         =intersect(teoel,c(tehgen)),
        "Secondary Energy|Electricity|Electricity-only|Waste (TWh/yr)"            =intersect(teoel,c("waste")),
        "Secondary Energy|Electricity|Electricity-only|Other Fossil (TWh/yr)"     =intersect(teoel,c(teothers,"waste",teoil)),
        "Secondary Energy|Electricity|Electricity-only|Fossil (TWh/yr)"           =intersect(teoel,c(tefossil)),
        "Secondary Energy|Electricity|Electricity-only|Fossil|w/o CCS (TWh/yr)"   =intersect(teoel,setdiff(tefossil,teccs)),
        "Secondary Energy|Electricity|Electricity-only|Fossil|w/ CCS (TWh/yr)"    =intersect(teoel,intersect(tefossil,teccs)),
        "Secondary Energy|Electricity|Electricity-only|Renewable (TWh/yr)"        =intersect(teoel,c(ter,ternofluc)),
        "Secondary Energy|Electricity|Electricity-only|Non-renewable (TWh/yr)"    =intersect(teoel,tenr) #this does not include storage
      )
      
      for (var in names(varList_el2)){
        tmp2 <- mbind(tmp2,setNames(dimSums(dimSums(v_seprod_el[,,varList_el2[[var]]],dim=c(3.2,3.3))*p_taulength,dim=3)/1000,var))
      }
      
    }
    
  }
  
  # add global values
  tmp3 <- mbind(tmp1,tmp2)
  
  
  #STORAGE-RELATED
  tmp4 <- NULL
  #Hydrogen (from electrolysis) used in hydrogen-based generation plants
  if(c_LIMESversion >= 2.34) {
    v_p2xse <- readGDX(gdx,name="v_p2xse",field="l",format="first_found")[,,"pehgen.seel"]
    v_p2xse <- v_p2xse[,,tehgen]
    v_p2xse <- limesMapping(v_p2xse[,,tau])
    
    varList_hgen <- list(
      "Secondary Energy|Hydrogen|Electricity (TWh/yr)" = NA,
      "Secondary Energy|Hydrogen|Hydrogen FC (TWh/yr)" = "hfc",
      "Secondary Energy|Hydrogen|Hydrogen OC (TWh/yr)" = "hct",
      "Secondary Energy|Hydrogen|Hydrogen CC (TWh/yr)" = "hcc"
    )
    
    for (var in names(varList_hgen)){
      tmp4 <- mbind(tmp4,setNames(dimSums(dimSums(v_p2xse[,,varList_hgen[[var]]],dim=c(3.2))*p_taulength,dim=3)/1000,var))
    }
    
  }
  
  #Storage generation
  varList_st <- list(
    "Secondary Energy|Electricity|Storage (TWh/yr)"                       =NA,
    "Secondary Energy|Electricity|Storage|Pump Hydro (TWh/yr)"            ="psp",           
    "Secondary Energy|Electricity|Storage|Stat Batteries (TWh/yr)"        ="batteries",               
    "Secondary Energy|Electricity|Storage|Hydrogen electrolysis (TWh/yr)" ="helec"                     
  )
  
  for (var in names(varList_st)){
    tmp4 <- mbind(tmp4,setNames(dimSums(dimSums(v_storeout[,,varList_st[[var]]],dim=c(3.2))*p_taulength,dim=3)/1000,var))
  }
  
  #Storage consumption
  varList_st <- list(
    "Secondary Energy|Electricity|Storage Consumption (TWh/yr)"                       =NA,
    "Secondary Energy|Electricity|Storage Consumption|Pump Hydro (TWh/yr)"            ="psp",           
    "Secondary Energy|Electricity|Storage Consumption|Stat Batteries (TWh/yr)"        ="batteries",               
    "Secondary Energy|Electricity|Storage Consumption|Hydrogen electrolysis (TWh/yr)" ="helec"                     
  )
  
  for (var in names(varList_st)){
    tmp4 <- mbind(tmp4,setNames(dimSums(dimSums(v_storein[,,varList_st[[var]]],dim=c(3.2))*p_taulength,dim=3)/1000,var))
  }
  
  #Storage losses
  tmp4 <- mbind(tmp4,setNames(dimSums((dimSums(v_storein,dim=c(3.2)) - dimSums(v_storeout,dim=c(3.2)))*p_taulength/1000,dim=3),"Secondary Energy|Electricity|Storage Losses (TWh/yr)"))
  
  #aggregate tmp
  tmp5 <- mbind(tmp3,tmp4)
  
  #Gross production and demand
  tmp6 <- NULL
  #Need to create a variable with t,regi,te for gross production (v_seprod has these indexes)
  o_grossprod <- new.magpie(cells_and_regions = getRegions(v_seprod_el), years = getYears(v_seprod_el), names = c(teel),
                                       fill = 0, sort = FALSE, sets = NULL, unit = "unknown")
  #Estimate annual gross production for different technologies (in TWh/yr)
  for (teel2 in teel) {
    o_grossprod[,,teel2] <- dimSums(collapseNames(dimSums(v_seprod_el[,,teel2],dim=c(3.2)))*p_taulength/1000,dim=3)*(1+p_autocons[,,teel2])
  }
  
  tmp6 <- mbind(tmp6,setNames(dimSums(o_grossprod[,,intersect(teel,c(telig))],dim=3),"Gross Production|Electricity|Lignite (TWh/yr)"))
  tmp6 <- mbind(tmp6,setNames(dimSums(o_grossprod[,,intersect(teel,c(tecoal))],dim=3),"Gross Production|Electricity|Coal (TWh/yr)"))
  tmp6 <- mbind(tmp6,setNames(dimSums(o_grossprod[,,intersect(teel,c(tegas))],dim=3),"Gross Production|Electricity|Gas (TWh/yr)"))
  tmp6 <- mbind(tmp6,setNames(dimSums(o_grossprod[,,intersect(teel,c(tefossil))],dim=3),"Gross Production|Electricity|Fossil (TWh/yr)"))
  tmp6 <- mbind(tmp6,setNames(dimSums(o_grossprod[,,intersect(teel,c("tnr"))],dim=3),"Gross Production|Electricity|Nuclear (TWh/yr)"))
  
  #Net imports
  o_netimpots <- new.magpie(cells_and_regions = getRegions(p_eldemand), years = getYears(p_eldemand), names = tau,
                                         fill = 0, sort = FALSE, sets = NULL, unit = "unknown")
  o_netimpots <- dimSums(p_eldemand*p_taulength/1000,dim=3) - setNames(tmp1[,,"Secondary Energy||Electricity|w/o losses (TWh/yr)"],NULL)
  
  #Gross demand (gross electricity production + net imports), following official german statistics procedure
  o_grossdem <- dimSums(o_grossprod,dim=c(3.1)) + o_netimpots
  tmp6 <- mbind(tmp6,setNames(o_grossdem,"Secondary Energy|Electricity|Gross Demand (TWh/yr)"))
  tmp6 <- mbind(tmp6,setNames(dimSums(o_grossprod[,,intersect(teel,c(ter,ternofluc))],dim=3)/o_grossdem,"Secondary Energy|Electricity|Share of renewables in gross demand (--)"))
  
  #merge tmp's
  tmp7 <- mbind(tmp5,tmp6)
  
  #CURTAILMENT
  v_seprodmax <- readGDX(gdx,name="v_seprodmax",field="l",format="first_found",restore_zeros = FALSE)[,,tau]
  v_seprodmax <- limesMapping(v_seprodmax)
  o_genvres <- setNames(tmp1[,,"Secondary Energy|Electricity|Variable renewable (TWh/yr)"],NULL) 
  tmp8 <- NULL
  tmp8 <- mbind(tmp8,setNames(dimSums(dimSums(v_seprodmax[,,ter],dim=c(3.2))*p_taulength,dim=3)/1000-o_genvres,"Secondary Energy|Electricity|Curtailment (TWh/yr)"))
  
  #merge tmp's
  tmp <- mbind(tmp7,tmp8)

  return(tmp)
}